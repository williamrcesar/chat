<% content_for :title, "Atendimento ##{@assignment.id}" %>

<div class="max-w-4xl">
  <%# Back + header %>
  <div class="flex items-center gap-3 mb-6">
    <%= link_to company_assignments_path, class: "text-[#8696a0] hover:text-white transition-colors" do %>
      ← Voltar
    <% end %>
    <h1 class="text-xl font-semibold text-white">Atendimento #<%= @assignment.id %></h1>
    <% badge = {
      "pending"     => ["bg-yellow-500/20 text-yellow-400", "Aguardando"],
      "queued"      => ["bg-blue-500/20 text-blue-400", "Na Fila"],
      "active"      => ["bg-[#00a884]/20 text-[#00a884]", "Em Atendimento"],
      "transferred" => ["bg-purple-500/20 text-purple-400", "Transferido"],
      "resolved"    => ["bg-[#8696a0]/20 text-[#8696a0]", "Resolvido"]
    }[@assignment.status] || ["", @assignment.status] %>
    <span class="<%= badge[0] %> text-xs px-2 py-0.5 rounded-full"><%= badge[1] %></span>
  </div>

  <div class="grid grid-cols-3 gap-6">
    <%# Message thread %>
    <div class="col-span-2">
      <div class="bg-[#0b141a] rounded-xl h-[60vh] overflow-y-auto p-4 space-y-3 flex flex-col-reverse">
        <% @messages.reverse.each do |msg| %>
          <div class="flex <%= msg.sender_id == current_user.id ? 'justify-end' : 'justify-start' %>">
            <div class="max-w-xs lg:max-w-sm rounded-lg px-4 py-2 shadow
                        <%= msg.sender_id == current_user.id ? 'bg-[#005c4b] text-white' : 'bg-[#202c33] text-white' %>">
              <p class="text-xs text-[#8696a0] mb-1 font-medium"><%= msg.sender.display_name %></p>
              <p class="text-sm leading-relaxed whitespace-pre-wrap"><%= msg.content %></p>
              <p class="text-[#8696a0] text-xs mt-1 text-right"><%= msg.created_at.strftime("%H:%M") %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%# Sidebar — assignment details + actions %>
    <div class="col-span-1 space-y-4">
      <div class="bg-[#202c33] rounded-xl p-4">
        <h3 class="text-white text-sm font-semibold mb-3">Detalhes</h3>
        <dl class="space-y-2 text-sm">
          <div>
            <dt class="text-[#8696a0] text-xs">Departamento</dt>
            <dd class="text-white mt-0.5"><%= @assignment.selected_department.presence || "—" %></dd>
          </div>
          <div>
            <dt class="text-[#8696a0] text-xs">Atendente</dt>
            <dd class="text-white mt-0.5"><%= @assignment.company_attendant&.user&.display_name || "Não atribuído" %></dd>
          </div>
          <div>
            <dt class="text-[#8696a0] text-xs">Início</dt>
            <dd class="text-white mt-0.5"><%= @assignment.created_at.strftime("%d/%m/%Y %H:%M") %></dd>
          </div>
          <% if @assignment.assigned_at %>
            <div>
              <dt class="text-[#8696a0] text-xs">Atribuído em</dt>
              <dd class="text-white mt-0.5"><%= @assignment.assigned_at.strftime("%d/%m/%Y %H:%M") %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <% if @current_company.supervisor?(current_user) && !@assignment.status_resolved? %>
        <%# Transfer %>
        <div class="bg-[#202c33] rounded-xl p-4">
          <h3 class="text-white text-sm font-semibold mb-3">Transferir</h3>
          <%= form_with url: transfer_company_assignment_path(@assignment), method: :patch, class: "space-y-3" do |f| %>
            <select name="attendant_id"
                    class="w-full bg-[#2a3942] text-white text-sm rounded-lg px-3 py-2 outline-none border border-transparent focus:border-[#00a884]">
              <option value="">Selecionar atendente</option>
              <% @current_company.company_attendants.status_available.includes(:user).each do |att| %>
                <option value="<%= att.id %>"><%= att.user.display_name %> (<%= att.role_name %>)</option>
              <% end %>
            </select>
            <%= f.submit "Transferir",
                  class: "w-full bg-[#2a3942] hover:bg-[#3b4a54] text-white text-sm font-semibold py-2 rounded-lg transition-colors cursor-pointer" %>
          <% end %>
        </div>

        <%# Resolve %>
        <%= button_to resolve_company_assignment_path(@assignment), method: :patch,
              data: { confirm: "Encerrar este atendimento?" },
              class: "w-full bg-[#00a884]/20 hover:bg-[#00a884]/30 text-[#00a884] text-sm font-semibold py-2.5 rounded-xl transition-colors cursor-pointer" do %>
          Marcar como Resolvido
        <% end %>
      <% end %>
    </div>
  </div>
</div>
